# 메이플랜드 경험치 측정 기능 정리

> 홈페이지에서 화면 지정 구역 OCR로 자동 경험치 측정이 가능한지 검토한 내용 정리 (까먹지 않기용)

---

## 1. 하고 싶은 기능

- **수동 계산기의 한계**: "현재 경험치"와 "1시간 후 경험치"를 직접 입력하면 그냥 계산기일 뿐, 유익하지 않음.
- **원하는 것**: **자동으로** 경험치를 재는 기능.
  - 사용자가 화면에서 **경험치가 보이는 구역을 사각형으로 지정**
  - 그 구역을 **OCR**로 읽어서 **현재 경험치**를 화면에 표시
  - 사용자가 OK → **START** 버튼 표시
  - START 누르면 **실시간 타이머** + **얼마나 경험치를 먹었는지** 측정 (시간당 경험치 등)

---

## 2. "사각형 지정 + OCR"이 웹(홈페이지)에서 가능한가?

**가능하다.** 브라우저 API만으로 구현 가능.

---

## 3. 화면 구역 가져오기: Screen Capture API

- **`getDisplayMedia()`** 로 사용자가 선택한 **화면/창**을 비디오 스트림으로 받을 수 있음.
- "화면 공유" 허용 → 게임 창(또는 전체 화면)을 페이지 안에서 재생하는 식으로 사용.
- 그 스트림을 **캔버스에 그린 뒤**, **사각형으로 지정한 영역만 잘라서 이미지**로 만들 수 있음.
- 따라서 **"지정한 사각형 구역"의 이미지를 웹에서 얻는 것은 가능.**

---

## 4. 그 구역에서 숫자 읽기: OCR

- **Tesseract.js** 같은 **브라우저용 OCR** 라이브러리 사용.
- 잘라낸 이미지를 Tesseract에 넘기면 텍스트(숫자)를 받을 수 있음 → "현재 경험치"로 파싱.
- **서버 없이** 프론트엔드만으로 동작 가능.

---

## 5. 전체 흐름 (웹에서 자동 경험치 측정)

| 단계 | 내용 |
|------|------|
| 1 | "화면 공유 시작" → `getDisplayMedia()` 로 게임 화면 스트림 획득 |
| 2 | 스트림을 화면에 띄우고, 사용자가 **경험치가 보이는 구역을 사각형으로 지정** (드래그로 영역 선택) |
| 3 | 주기적으로(예: 1~2초마다) 그 사각형 영역만 캔버스에서 잘라서 이미지로 만듦 |
| 4 | Tesseract.js 로 그 이미지 OCR → 문자열에서 숫자만 파싱 → **현재 경험치**로 사용 |
| 5 | 사용자가 OK → **START** 버튼 노출 → START 시점 경험치·시간 기록 |
| 6 | 실시간으로: 경과 시간, 현재 경험치, 증가량, **시간당 경험치(EXP/h)** 계산해서 표시 |

---

## 6. 웹으로 할 때 참고 사항

- **화면 공유**: 사용자가 매번(또는 세션마다) "공유할 화면/창"을 선택해야 함. "경험치 위치를 사각형으로 지정"하는 건, 공유된 화면이 보이는 상태에서 그 위에 사각형을 그려서 지정하는 방식으로 구현하면 됨.
- **OCR 정확도**: 게임 폰트가 읽기 쉬우면 숫자만 읽을 때는 Tesseract로도 충분한 경우가 많음. "숫자만 인식" 옵션을 두면 더 안정적.
- **보안**: `getDisplayMedia()` 는 **HTTPS** 또는 **localhost** 에서만 동작. 실제 서비스할 때는 HTTPS 필수.

---

## 7. 사용 기술 요약

- **화면 캡처**: `getDisplayMedia()` (Screen Capture API)
- **영역 crop**: Canvas 2D (스트림 → 캔버스 → crop)
- **OCR**: Tesseract.js (브라우저에서 실행, 서버 불필요)

이 조합이면 **데스크톱 전용 프로그램 없이 홈페이지만으로** "지정 구역 자동 경험치 측정" 기능 구현 가능.

---

## 8. 나중에 적용할 것

### 8-1. 해상도 제한

- **이유**: 해상도가 너무 낮으면 경험치 숫자 픽셀이 작아져서 OCR 인식률이 떨어짐.
- **계획**: 특정 해상도(또는 최소 해상도) 내에서만 측정 가능하도록 제한.
- **구현**: 공유 스트림의 `videoWidth` / `videoHeight` 확인 후, 허용 목록(또는 최소 width/height)에 없으면 스트림 중지 + "지원하는 해상도에서만 측정할 수 있습니다" 안내.

### 8-2. 고정 비율일 때 사각형 생략 (프리셋 영역)

- **개념**: 메이플스토리 월드 UI가 해상도/비율이 정해지면 **경험치 위치가 항상 같다**면, 사용자가 네모를 그릴 필요 없음.
- **방법**:
  - 허용 해상도별로 **경험치 영역 (x, y, w, h)** 를 미리 정의해 두거나,
  - 비율이 같다면 **화면 대비 비율(%)** 로 영역을 두고, 공유 해상도에 맞춰 픽셀 좌표로 변환.
- **흐름**: 화면 공유 → MapleStory Worlds 선택 → (해상도 허용 시) **자동으로 프리셋 영역 사용** → "경험치 읽기" 또는 바로 START.
- **장점**: 사용자 경험 단순화, 한 번만 설정해 두면 됨.

---

## 9. 현재까지 구현 완료된 부분

- **화면 공유** → `getDisplayMedia()` 로 스트림 획득.
- **풀 캡처** → 공유 직후 한 프레임을 전체 화면 기준으로 캡처해 스냅샷 캔버스에 표시 (최대 1280px 너비로 스케일).
- **영역 지정** → 스냅샷 위에서 드래그로 사각형 지정. 「영역 다시 찾기」로 EXP 텍스트 기반 자동 감지 지원.
- **경험치 읽기** → 선택 영역만 잘라 Tesseract.js OCR → `23,456,789[45.03%]` 형태 파싱 (경험치 + 퍼센트).
- **OK → START** → 시작 경험치·시각 기록.
- **측정 중** → 1초마다 **ImageCapture**로 스트림에서 프레임을 가져와, START 시점에 변환해 둔 비디오 픽셀 영역만 잘라 OCR. 경과 시간, 획득 경험치, 시간당 EXP, 5/10/30/60분 예상 EXP 표시. 구간 통과 시 연두색 강조.
- **공유 화면** → 기본 숨김(렉 방지). 측정 중에는 2px만 보이게 해 두었으나, 실제 OCR은 **ImageCapture**로 스트림에서 직접 grabFrame 하여 수행.
- **무음 재생** → 백그라운드 탭에서도 타이머/디코딩 유지를 위해 무음 오디오 사용 (선택).

---

## 10. 주의할 부분 — 경험치 측정이 되지 않았던 이유

- **원인**: 측정 중에 비디오 요소를 **2px × 2px** 로만 두어, 브라우저가 비디오 디코딩을 생략할 수 있음. 그 결과 `video.videoWidth` / `video.videoHeight` 가 **0** 이 되고, `if (vw < 10 || vh < 10) return null` 로 매번 OCR이 스킵되어 **측정이 전혀 갱신되지 않는 현상** 발생.
- **해결**: 측정 중 OCR 시 **비디오 요소에 의존하지 않고**, `video.srcObject`(스트림)에서 **ImageCapture.grabFrame()** 으로 매번 프레임을 가져와, 그 프레임에서 선택 영역만 잘라 OCR하도록 변경. 이렇게 하면 2px 비디오 상태에서도 측정이 정상 동작.
- **앞으로 유의**:  
  - 비디오 요소를 극도로 축소해 두는 방식(2px 등)으로 “숨기기”만 하고 OCR 소스로 쓰면, 환경에 따라 디코딩이 되지 않을 수 있음.  
  - **실제로 프레임이 필요한 로직(측정 OCR)** 은 **ImageCapture + 스트림** 또는 **충분한 크기의 비디오**를 사용하는 것이 안전함.

---

## 11. 앞으로 진행할 것 — 최적화 & UI·편의 기능

- **최적화**
  - 캡처 영역을 다시 **하단 10% + 가운데 1/3** 등으로 줄여 OCR 부하 감소 (좌표 체인 정확히 맞출 것).
  - OCR 주기·해상도·PSM 등 튜닝으로 인식률·속도 개선.

- **UI·디자인**
  - **5분 / 10분 / 30분 / 1시간** 구간을 **보기 좋게 디자인** (카드형, 아이콘, 진행 바 등).
  - 측정 중 통계 영역 레이아웃·가독성 개선.

- **캡처·영역 지정 편의**
  - **캡처 과정에 애니메이션** (로딩, 완료 피드백 등).
  - **네모 영역이 최초부터 자동 지정**되도록 (풀 캡처 시에도 자동 감지로 박스 채우기, 또는 하단 크롭 복원 시 정밀 자동 영역).
  - 자동 감지 실패 시에만 “드래그로 지정” 유도.

- **기타 편의**
  - 단축키, “다시 캡처” 후 자동 재감지, 경험치 읽기 전 미리보기 등.
